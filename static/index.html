<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML Merger & Stylizer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for dark mode toggle if needed */
        .dark .dark\:bg-gray-800 { background-color: #1f2937; }
        .dark .dark\:bg-gray-900 { background-color: #111827; }
        .dark .dark\:text-gray-200 { color: #e5e7eb; }
        .dark .dark\:text-gray-400 { color: #9ca3af; }
        .dark .dark\:border-gray-700 { border-color: #374151; }
        .dark .dark\:hover\:border-blue-400 { border-color: #60a5fa; }
        .dark .dark\:bg-gray-700 { background-color: #374151; }
        .dark .dark\:shadow-md-dark { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06), 0 0 0 1px rgba(255,255,255,0.05); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-gray-200 flex-grow">Merge & Style KML Files</h1>
            <button id="theme-toggle" class="p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.071a1 1 0 001.414 1.414l.707-.707a1 1 0 00-1.414-1.414l-.707.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md dark:shadow-md-dark p-6 mb-6">
            <div class="border-4 border-dashed border-blue-300 hover:border-blue-500 dark:hover:border-blue-400 bg-gray-50 dark:bg-gray-700 rounded-lg p-8 text-center transition-colors duration-300" id="drop-zone">
                <label class="block">
                    <span class="inline-block px-4 py-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600 transition-colors">
                        Select KML Files
                    </span>
                    <input type="file" id="kml-files" accept=".kml" multiple class="hidden">
                </label>
                <p class="mt-2 text-sm text-gray-600">or drag and drop files here</p>
            </div>

            <div id="file-list" class="mt-4 space-y-2">
                <p class="text-red-600 dark:text-red-400 italic text-center font-semibold" id="no-files-message">No files selected yet</p>
            </div>
        </div>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 dark:bg-red-900 dark:border-red-700 dark:text-red-300 px-4 py-3 rounded relative mb-4"></div>
        
        <div id="loading" class="hidden text-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 dark:border-blue-400 mx-auto"></div>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Merging files...</p>
        </div>

        <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
            <div class="mb-4">
                <label for="output-filename" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Output File Name (optional, without .kml extension):</label>
                <input type="text" id="output-filename" name="outputFilename" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="merged">
            </div>
            <button type="submit" id="merge-button" disabled
                class="w-full py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 dark:hover:bg-blue-400 transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
                Merge Files
            </button>
        </form>
    </div>

    <script>
        let fileCounter = 0;
        const fileList = document.getElementById('file-list');
        const uploadForm = document.getElementById('upload-form');
        const mergeButton = document.getElementById('merge-button');
        const dropZone = document.getElementById('drop-zone');
        const noFilesMessage = document.getElementById('no-files-message');

        function handleFiles(files, index) {
            if (files.length === 0) return;
            
            document.getElementById('error-message').classList.add('hidden');
            
            if (noFilesMessage) {
                noFilesMessage.remove();
            }
            mergeButton.disabled = false;
            
            let validFiles = 0;
            for (const file of files) {
                if (file.name.toLowerCase().endsWith('.kml')) {
                    addFileToList(file);
                    validFiles++;
                }
            }
            
            mergeButton.disabled = validFiles === 0;
        }

        function addFileToList(file) {
            const fileId = `file-${fileCounter}`;
            const fileIndex = fileCounter++; // Benzersiz index için

            const fileItem = document.createElement('div');
            fileItem.className = 'file-item bg-gray-50 dark:bg-gray-700 p-3 rounded-lg mb-2';
            fileItem.dataset.fileName = file.name;
            fileItem.dataset.fileIndex = fileIndex; // Stilleri almak için index'i sakla
            fileItem.id = fileId;
            fileItem.fileData = file;

            fileItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-700 dark:text-gray-200 truncate flex-1 font-medium">${file.name}</span>
                    <button type="button" class="ml-2 text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300" onclick="removeFile('${fileId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600 grid grid-cols-2 sm:grid-cols-4 gap-2 items-center">
                    <div>
                        <label for="line-color-${fileIndex}" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Line Color:</label>
                        <input type="color" id="line-color-${fileIndex}" value="#ff0000" class="h-8 w-full border border-gray-300 dark:border-gray-600 rounded p-1 dark:bg-gray-600 dark:text-gray-200">
                    </div>
                    <div>
                        <label for="line-width-${fileIndex}" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Line Width:</label>
                        <input type="number" id="line-width-${fileIndex}" value="2" min="1" class="h-8 w-full border border-gray-300 dark:border-gray-600 rounded text-center p-1 dark:bg-gray-600 dark:text-gray-200">
                    </div>
                    <div>
                        <label for="fill-color-${fileIndex}" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Fill Color:</label>
                        <input type="color" id="fill-color-${fileIndex}" value="#00ff00" class="h-8 w-full border border-gray-300 dark:border-gray-600 rounded p-1 dark:bg-gray-600 dark:text-gray-200">
                    </div>
                    <div>
                        <label for="fill-opacity-${fileIndex}" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Fill Opacity (%):</label>
                        <input type="number" id="fill-opacity-${fileIndex}" value="50" min="0" max="100" class="h-8 w-full border border-gray-300 dark:border-gray-600 rounded text-center p-1 dark:bg-gray-600 dark:text-gray-200">
                    </div>
                </div>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileId) {
            const fileItem = document.getElementById(fileId);
            if (fileItem) {
                fileItem.remove();
                
                if (fileList.children.length === 0) {
                    fileList.innerHTML = '<p class="text-red-600 dark:text-red-400 italic text-center font-semibold" id="no-files-message">No files selected yet</p>';
                    mergeButton.disabled = true;
                }
            }
        }

        document.getElementById('kml-files').addEventListener('change', (e) => handleFiles(e.target.files));

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            handleFiles(e.dataTransfer.files);
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileItems = Array.from(fileList.children).filter(item => item.id && item.fileData);

            if (fileItems.length === 0) {
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = 'Please select at least one KML file.';
                errorMessage.classList.remove('hidden');
                return;
            }

            const formData = new FormData();
            const styles = {};
            fileItems.forEach((item) => {
                formData.append('files', item.fileData, item.dataset.fileName); // Backend'in 'files' olarak beklemesi için
                const fileIndex = item.dataset.fileIndex;

                const lineColorInput = document.getElementById(`line-color-${fileIndex}`);
                const lineWidthInput = document.getElementById(`line-width-${fileIndex}`);
                const fillColorInput = document.getElementById(`fill-color-${fileIndex}`);
                const fillOpacityInput = document.getElementById(`fill-opacity-${fileIndex}`);

                // Değerlerin varlığını kontrol et, yoksa varsayılan kullan
                const lineColor = lineColorInput ? lineColorInput.value : '#ff0000';
                const lineWidth = lineWidthInput ? parseInt(lineWidthInput.value, 10) : 2;
                const fillColor = fillColorInput ? fillColorInput.value : '#00ff00';
                const fillOpacity = fillOpacityInput ? parseInt(fillOpacityInput.value, 10) : 50;

                const kmlFillOpacity = Math.round((fillOpacity / 100) * 255).toString(16).padStart(2, '0');
                // KML renk formatı: aabbggrr (alpha, blue, green, red)
                const kmlLineColor = `ff${lineColor.substring(5, 7)}${lineColor.substring(3, 5)}${lineColor.substring(1, 3)}`; // Tam opak çizgi (ff)
                const kmlFillColor = `${kmlFillOpacity}${fillColor.substring(5, 7)}${fillColor.substring(3, 5)}${fillColor.substring(1, 3)}`;

                styles[item.dataset.fileName] = {
                    line_color: kmlLineColor,
                    line_width: lineWidth,
                    fill_color: kmlFillColor
                    // fill_opacity KML rengine dahil edildi
                };
            });
            formData.append('styles', JSON.stringify(styles));

            // Add output filename to form data if provided
            const outputFilenameInput = document.getElementById('output-filename');
            const outputFilename = outputFilenameInput.value.trim();
            if (outputFilename) {
                formData.append('outputFilename', outputFilename);
            }

            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            mergeButton.disabled = true;
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('File merge operation failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // Use filename from header if available, otherwise default
                const contentDisposition = response.headers.get('content-disposition');
                let downloadFilename = 'merged.kml'; // Default filename
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+?)"?$/);
                    if (filenameMatch && filenameMatch.length > 1) {
                        downloadFilename = filenameMatch[1];
                    }
                }
                a.download = downloadFilename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = error.message.replace('Dosya yüklenmedi', 'No files uploaded').replace('birleştirme', 'merge');
                errorMessage.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                mergeButton.disabled = false;
            }
        });
    </script>
</body>
</html>